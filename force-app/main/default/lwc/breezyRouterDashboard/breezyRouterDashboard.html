<template>
    <!-- Dashboard Controls -->
    <div class="dashboard-controls slds-m-bottom_medium">
        <div class="slds-grid slds-grid_vertical-align-center slds-grid_align-spread">
            <div>
                <h2 class="slds-text-heading_medium slds-m-bottom_x-small">Analytics & Insights</h2>
                <p class="slds-text-body_small slds-text-color_weak">
                    Comprehensive analytics for your routing operations
                </p>
            </div>
            <div class="slds-grid slds-grid_vertical-align-center slds-grid_align-end slds-gutters">
                <div class="slds-col slds-no-flex">
                    <lightning-combobox
                        name="timeRange"
                        label="Time Range"
                        value={selectedTimeRange}
                        placeholder="Select time range"
                        options={timeRangeOptions}
                        onchange={handleTimeRangeChange}
                        variant="label-hidden">
                    </lightning-combobox>
                </div>
                <div class="slds-col slds-no-flex controls-button">
                    <lightning-button-icon 
                        icon-name="utility:refresh" 
                        alternative-text="Refresh" 
                        onclick={handleRefresh}
                        disabled={isLoading}
                        variant="border-filled"
                        class="refresh-button">
                    </lightning-button-icon>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <template if:true={isLoading}>
        <div class="slds-text-align_center slds-p-around_large">
            <lightning-spinner alternative-text="Loading dashboard data..." size="medium"></lightning-spinner>
        </div>
    </template>

    <!-- Dashboard Content -->
    <template if:false={isLoading}>
        
        <!-- Key Metrics Cards -->
        <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_large">
            <div class="slds-col slds-size_1-of-6">
                <div class="metric-card slds-box slds-text-align_center">
                    <div class="metric-icon slds-m-bottom_small">
                        <lightning-icon icon-name="utility:routing" size="medium" variant="brand"></lightning-icon>
                    </div>
                    <div class="metric-value slds-text-heading_large">{totalRouters}</div>
                    <div class="metric-label slds-text-body_small">Total Routers</div>
                    <div class="metric-percentage"></div>
                </div>
            </div>
            <div class="slds-col slds-size_1-of-6">
                <div class="metric-card slds-box slds-text-align_center">
                    <div class="metric-icon slds-m-bottom_small">
                        <lightning-icon icon-name="utility:user" size="medium" variant="success"></lightning-icon>
                    </div>
                    <div class="metric-value slds-text-heading_large">{totalMembers}</div>
                    <div class="metric-label slds-text-body_small">Total Members</div>
                    <div class="metric-percentage"></div>
                </div>
            </div>
            <div class="slds-col slds-size_1-of-6">
                <div class="metric-card slds-box slds-text-align_center">
                    <div class="metric-icon slds-m-bottom_small">
                        <lightning-icon icon-name="utility:check" size="medium" variant="success"></lightning-icon>
                    </div>
                    <div class="metric-value slds-text-heading_large">{activeMembers}</div>
                    <div class="metric-label slds-text-body_small">Active Members</div>
                    <div class="metric-percentage slds-text-body_small slds-text-color_success">{activePercentage}%</div>
                </div>
            </div>
            <div class="slds-col slds-size_1-of-6">
                <div class="metric-card slds-box slds-text-align_center">
                    <div class="metric-icon slds-m-bottom_small">
                        <lightning-icon icon-name="utility:block" size="medium" variant="error"></lightning-icon>
                    </div>
                    <div class="metric-value slds-text-heading_large">{inactiveMembers}</div>
                    <div class="metric-label slds-text-body_small">Inactive Members</div>
                    <div class="metric-percentage slds-text-body_small slds-text-color_error">{inactivePercentage}%</div>
                </div>
            </div>
            <div class="slds-col slds-size_1-of-6">
                <div class="metric-card slds-box slds-text-align_center">
                    <div class="metric-icon slds-m-bottom_small">
                        <lightning-icon icon-name="utility:sync" size="medium" variant="brand"></lightning-icon>
                    </div>
                    <div class="metric-value slds-text-heading_large">{totalRoutings}</div>
                    <div class="metric-label slds-text-body_small">Total Routings</div>
                    <div class="metric-percentage"></div>
                </div>
            </div>
            <div class="slds-col slds-size_1-of-6">
                <div class="metric-card slds-box slds-text-align_center">
                    <div class="metric-icon slds-m-bottom_small">
                        <lightning-icon icon-name="utility:chart" size="medium" variant="brand"></lightning-icon>
                    </div>
                    <div class="metric-value slds-text-heading_large">{averageRoutingsPerDay}</div>
                    <div class="metric-label slds-text-body_small">Avg/Day</div>
                    <div class="metric-percentage"></div>
                </div>
            </div>
        </div>

        <!-- Analytics Charts Section -->
        <div class="slds-grid slds-wrap slds-gutters">
            
            <!-- Router Analytics Chart -->
            <div class="slds-col slds-size_1-of-2">
                <div class="chart-container slds-box">
                    <div class="chart-header slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small">Router Performance</h3>
                        <p class="slds-text-body_small slds-text-color_weak">Routing activity by router</p>
                    </div>
                    <template if:true={hasRouterAnalytics}>
                        <div class="analytics-chart">
                            <template for:each={routerAnalytics} for:item="router">
                                <div key={router.routerId} class="router-analytics-item slds-m-bottom_small">
                                    <div class="slds-grid slds-grid_vertical-align-center">
                                        <div class="slds-col slds-size_1-of-3">
                                            <div class="router-name slds-text-body_regular slds-text-title_caps">{router.routerName}</div>
                                        </div>
                                        <div class="slds-col slds-size_1-of-3">
                                            <div class="routing-count slds-text-body_regular slds-text-align_center">
                                                <strong>{router.routingCount}</strong> routings
                                            </div>
                                        </div>
                                        <div class="slds-col slds-size_1-of-3">
                                            <div class="last-routed slds-text-body_small slds-text-color_weak slds-text-align_right">
                                                <template if:true={router.lastRoutedDate}>
                                                    <lightning-formatted-date-time value={router.lastRoutedDate}></lightning-formatted-date-time>
                                                </template>
                                                <template if:false={router.lastRoutedDate}>
                                                    Never routed
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="progress-bar slds-m-top_x-small">
                                        <div class="progress-fill" style={router.progressStyle}></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template if:false={hasRouterAnalytics}>
                        <div class="slds-text-align_center slds-p-around_large">
                            <p class="slds-text-color_weak">No router analytics data available</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Routing Frequency Chart -->
            <div class="slds-col slds-size_1-of-2">
                <div class="chart-container slds-box">
                    <div class="chart-header slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small">Routing Frequency</h3>
                        <p class="slds-text-body_small slds-text-color_weak">Daily routing patterns</p>
                    </div>
                    <template if:true={hasRoutingFrequency}>
                        <div class="frequency-chart">
                            <template for:each={routingFrequency} for:item="day">
                                <div key={day.date} class="frequency-item slds-m-bottom_x-small">
                                    <div class="slds-grid slds-grid_vertical-align-center">
                                        <div class="slds-col slds-size_1-of-4">
                                            <div class="day-label slds-text-body_small slds-text-title_caps">{day.dayName}</div>
                                        </div>
                                        <div class="slds-col slds-size_1-of-4">
                                            <div class="day-count slds-text-body_regular slds-text-align_center">
                                                <strong>{day.routingCount}</strong>
                                            </div>
                                        </div>
                                        <div class="slds-col slds-size_1-of-2">
                                            <div class="frequency-bar">
                                                <div class="frequency-fill" style={day.barStyle}></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template if:false={hasRoutingFrequency}>
                        <div class="slds-text-align_center slds-p-around_large">
                            <p class="slds-text-color_weak">No routing frequency data available</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Additional Insights Section -->
        <div class="slds-grid slds-wrap slds-gutters slds-m-top_large">
            <div class="slds-col slds-size_1-of-1">
                <div class="insights-container slds-box">
                    <div class="chart-header slds-m-bottom_medium">
                        <h3 class="slds-text-heading_small">Key Insights</h3>
                        <p class="slds-text-body_small slds-text-color_weak">Automated analysis of your routing patterns</p>
                    </div>
                    <div class="insights-grid slds-grid slds-wrap slds-gutters">
                        <div class="slds-col slds-size_1-of-3">
                            <div class="insight-item">
                                <lightning-icon icon-name="utility:trending" size="small" variant="success" class="slds-m-right_x-small"></lightning-icon>
                                <span class="slds-text-body_small">
                                    <strong>Peak Activity:</strong> Most routings occur on weekdays
                                </span>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-3">
                            <div class="insight-item">
                                <lightning-icon icon-name="utility:info" size="small" variant="brand" class="slds-m-right_x-small"></lightning-icon>
                                <span class="slds-text-body_small">
                                    <strong>Efficiency:</strong> {activePercentage}% of members are actively routing
                                </span>
                            </div>
                        </div>
                        <div class="slds-col slds-size_1-of-3">
                            <div class="insight-item">
                                <lightning-icon icon-name="utility:clock" size="small" variant="warning" class="slds-m-right_x-small"></lightning-icon>
                                <span class="slds-text-body_small">
                                    <strong>Average:</strong> {averageRoutingsPerDay} routings per day
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </template>
</template>
